<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segmentation Hardware Simulation (Refined)</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
        }

        h2 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #7f8c8d; margin-bottom: 25px; }

        /* --- CONTROLS SECTION --- */
        .controls {
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
        }
        .input-group { display: flex; align-items: center; gap: 10px; }
        label { font-weight: 600; color: #34495e; }
        input {
            padding: 8px 12px;
            width: 70px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-random { background: #95a5a6; }
        .btn-random:hover { background: #7f8c8d; }

        /* --- DIAGRAM CANVAS --- */
        .diagram-container {
            position: relative;
            width: 800px;
            height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #dcdcdc;
            overflow: hidden;
        }

        /* --- COMPONENTS --- */
        
        /* 1. CPU Box */
        .cpu-box {
            position: absolute;
            top: 60px; left: 50px;
            width: 140px; height: 70px;
            border: 2px solid #2c3e50;
            border-radius: 6px;
            background: #ecf0f1;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }
        .cpu-label {
            font-size: 12px; font-weight: bold; color: #fff;
            background: #2c3e50; text-align: center; padding: 4px 0;
        }
        .cpu-registers {
            display: flex; flex: 1;
        }
        .reg {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-weight: bold; color: #34495e;
        }
        .reg:first-child { border-right: 1px solid #bdc3c7; }
        .reg span { font-size: 10px; color: #7f8c8d; margin-bottom: 2px; }

        /* 2. Segment Table */
        .seg-table-container {
            position: absolute;
            top: 40px; left: 280px;
            width: 160px;
            border: 2px solid #2c3e50;
            background: white;
            z-index: 2;
            border-radius: 4px;
            font-size: 13px;
        }
        .st-title {
            background: #2c3e50; color: white;
            text-align: center; font-weight: bold; padding: 5px; font-size: 12px;
        }
        .st-header {
            display: flex; background: #dfe6e9;
            font-weight: bold; border-bottom: 1px solid #bdc3c7;
        }
        .st-col { flex: 1; text-align: center; padding: 4px 0; }
        .st-row {
            display: flex; border-bottom: 1px solid #ecf0f1;
            height: 25px; align-items: center;
            transition: background 0.3s;
        }
        .st-row:last-child { border-bottom: none; }
        .st-row.active { background: #ffeaa7; }

        /* 3. Hardware Units (Comparator & Adder) */
        .hw-unit {
            position: absolute;
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: bold;
            color: #2c3e50;
            background: #fff;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .comparator { top: 250px; left: 330px; background: #fff0f0; } /* Light Red tint */
        .adder { top: 250px; left: 550px; background: #f0fff4; }      /* Light Green tint */
        
        .hw-label {
            position: absolute; top: -20px;
            font-size: 11px; color: #7f8c8d; font-weight: bold; width: 100px; text-align: center;
        }

        /* 4. Trap Box */
        .trap {
            position: absolute;
            top: 380px; left: 310px;
            width: 100px; padding: 8px 0;
            border: 2px dashed #e74c3c;
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            background: #fff;
            border-radius: 4px;
            display: none;
            z-index: 2;
        }

        /* 5. Physical Memory */
        .phy-mem {
            position: absolute;
            top: 40px; right: 50px;
            width: 120px; height: 400px;
            border: 2px solid #2c3e50;
            background: #ecf0f1;
            z-index: 2;
            display: flex; flex-direction: column;
            border-radius: 4px;
        }
        .mem-label {
            background: #2c3e50; color: white; font-size: 12px;
            text-align: center; padding: 5px; font-weight: bold;
        }
        .mem-body { flex: 1; position: relative; background: repeating-linear-gradient(0deg, #ecf0f1, #ecf0f1 19px, #bdc3c7 20px); }
        .mem-highlight {
            position: absolute;
            left: 0; width: 100%; height: 0;
            background: #27ae60;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 11px; font-weight: bold;
        }

        /* --- SVG WIRES --- */
        svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }
        /* Circuit lines */
        path {
            fill: none;
            stroke: #7f8c8d;
            stroke-width: 2;
            transition: stroke 0.3s;
        }
        /* Arrowheads */
        marker path { fill: #7f8c8d; }

        /* --- ANIMATION TOKENS --- */
        .token {
            position: absolute;
            width: 28px; height: 28px;
            background: white;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: left 0.8s ease-in-out, top 0.8s ease-in-out;
            opacity: 0;
        }
        .token-s { border-color: #2980b9; color: #2980b9; background: #eaf2f8; }
        .token-d { border-color: #c0392b; color: #c0392b; background: #f9e7e7; }
        .token-val { border-color: #f39c12; color: #d35400; background: #fef5e7; }
        .token-res { border-color: #27ae60; color: #27ae60; background: #eafaf1; width: 50px; }

        .status-bar {
            margin-top: 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            height: 20px;
        }

        .back-home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .back-home-btn:hover {
            transform: translateX(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        }

        .back-home-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <button class="back-home-btn" onclick="goHome()">
        â¬… Back to Home
    </button>

    <h2>Segmentation Hardware Simulation</h2>
    <p>Visualizing logical to physical address translation (Fig 8.8)</p>

    <div class="controls">
        <div class="input-group">
            <label for="in-s">Segment (s):</label>
            <input type="number" id="in-s" min="0" max="4" value="2">
        </div>
        <div class="input-group">
            <label for="in-d">Offset (d):</label>
            <input type="number" id="in-d" min="0" value="100">
        </div>
        <button id="btn-run" onclick="runSimulation()">Simulate</button>
        <button class="btn-random" onclick="randomize()">Random</button>
    </div>

    <div id="status-msg" class="status-bar">Ready.</div>

    <div class="diagram-container">
        <svg>
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L9,3 z" />
                </marker>
            </defs>
            
            <path d="M 85 130 L 85 160 L 260 160 L 260 80 L 280 80" marker-end="url(#arrow)"/>

            <path d="M 320 205 L 320 230 L 360 230 L 360 250" marker-end="url(#arrow)"/>

            <path d="M 400 205 L 400 230 L 580 230 L 580 250" marker-end="url(#arrow)"/>

            <path d="M 155 130 L 155 280 L 330 280" marker-end="url(#arrow)"/>

            <path d="M 390 280 L 550 280" marker-end="url(#arrow)"/>

            <path d="M 360 310 L 360 380" marker-end="url(#arrow)"/>

            <path d="M 610 280 L 630 280" marker-end="url(#arrow)"/>
        </svg>


        <div class="cpu-box">
            <div class="cpu-label">Logical Address</div>
            <div class="cpu-registers">
                <div class="reg"><span>Segment</span><div id="disp-s">s</div></div>
                <div class="reg"><span>Offset</span><div id="disp-d">d</div></div>
            </div>
        </div>

        <div class="seg-table-container">
            <div class="st-title">Segment Table</div>
            <div class="st-header">
                <div class="st-col">Limit</div>
                <div class="st-col">Base</div>
            </div>
            <div id="st-body">
                </div>
        </div>

        <div class="hw-unit comparator">
            <div class="hw-label">Limit Register</div>
            &lt;
        </div>

        <div class="hw-unit adder">
            <div class="hw-label">Relocation</div>
            +
        </div>

        <div class="trap" id="trap-box">TRAP: <br>Addressing Error</div>

        <div class="phy-mem">
            <div class="mem-label">Physical Memory</div>
            <div class="mem-body">
                <div id="mem-hl" class="mem-highlight"></div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC & DATA ---
        // Matches textbook examples usually found in these chapters
        const segments = [
            { limit: 1000, base: 1400 },
            { limit: 400,  base: 6300 },
            { limit: 400,  base: 4300 },
            { limit: 1100, base: 3200 },
            { limit: 1000, base: 4700 }
        ];

        // --- INITIALIZATION ---
        function init() {
            const tbody = document.getElementById('st-body');
            tbody.innerHTML = '';
            segments.forEach((seg, i) => {
                const row = document.createElement('div');
                row.className = 'st-row';
                row.id = `row-${i}`;
                row.innerHTML = `<div class="st-col">${seg.limit}</div><div class="st-col">${seg.base}</div>`;
                tbody.appendChild(row);
            });
        }

        function goHome() {
            window.location.href = "index.html"; // change if needed
            // OR use: window.history.back();
        }

        // --- ANIMATION UTILS ---
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        function setStatus(msg, color='#2c3e50') {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.style.color = color;
        }

        function createToken(text, type, x, y) {
            const container = document.querySelector('.diagram-container');
            const t = document.createElement('div');
            t.className = `token token-${type}`;
            t.innerText = text;
            t.style.left = x + 'px';
            t.style.top = y + 'px';
            container.appendChild(t);
            // Force reflow for transition
            void t.offsetWidth;
            t.style.opacity = 1;
            return t;
        }

        function randomize() {
            const s = Math.floor(Math.random() * 5);
            const limit = segments[s].limit;
            // 70% chance of valid address
            const isValid = Math.random() > 0.3;
            const d = isValid ? Math.floor(Math.random() * limit) : limit + Math.floor(Math.random() * 200);
            
            document.getElementById('in-s').value = s;
            document.getElementById('in-d').value = d;
            runSimulation();
        }

        // --- MAIN SIMULATION LOOP ---
        async function runSimulation() {
            const btn = document.getElementById('btn-run');
            btn.disabled = true;

            // Reset UI
            document.querySelectorAll('.token').forEach(t => t.remove());
            document.querySelectorAll('.st-row').forEach(r => r.classList.remove('active'));
            document.getElementById('trap-box').style.display = 'none';
            document.getElementById('mem-hl').style.opacity = 0;

            const sVal = parseInt(document.getElementById('in-s').value);
            const dVal = parseInt(document.getElementById('in-d').value);

            // Update CPU Display
            document.getElementById('disp-s').innerText = sVal;
            document.getElementById('disp-d').innerText = dVal;

            if (sVal < 0 || sVal >= segments.length) {
                setStatus("Error: Segment ID out of bounds", "red");
                btn.disabled = false;
                return;
            }

            // 1. Move 's' to Table
            setStatus(`Step 1: Index Segment Table with s=${sVal}`);
            const tS = createToken(sVal, 's', 70, 95); // CPU S center approx
            await wait(100);
            tS.style.top = '160px'; // Down to wire
            await wait(600);
            tS.style.left = '260px'; // Right along wire
            await wait(600);
            tS.style.top = '80px'; // Up to table input
            await wait(600);
            tS.style.left = '280px'; // Into table
            await wait(400);
            tS.remove();

            // Highlight Row
            const row = document.getElementById(`row-${sVal}`);
            row.classList.add('active');
            const { limit, base } = segments[sVal];
            
            setStatus(`Step 2: Retrieve Limit (${limit}) and Base (${base})`);
            await wait(800);

            // 2. Extract Limit and Base
            // Determine row Y position relative to container
            // Table top is 40px + header 45px approx. Each row 25px.
            const rowTop = 40 + 25 + 17 + (sVal * 25); 
            
            const tLim = createToken(limit, 'val', 300, rowTop);
            const tBase = createToken(base, 'val', 380, rowTop);
            
            await wait(100);
            // Move out of table
            tLim.style.top = '205px'; // Bottom of table
            tBase.style.top = '205px';
            await wait(600);

            // Move to Units
            // Limit -> Comparator (360, 250)
            tLim.style.left = '320px';
            await wait(300);
            tLim.style.top = '230px'; 
            await wait(300);
            tLim.style.left = '345px'; // Enter Comparator left side
            tLim.style.top = '265px'; // Center of Comparator Y (250+30 - half token)

            // Base -> Adder (580, 250)
            tBase.style.left = '580px'; // Move right
            await wait(300);
            tBase.style.top = '235px'; // Move down
            await wait(300);
            
            // 3. Move 'd' to Comparator AND Adder
            setStatus(`Step 3: Check Offset d < Limit`);
            const tD = createToken(dVal, 'd', 140, 95); // CPU D center
            await wait(100);
            tD.style.top = '280px'; // Down wire
            await wait(800);
            tD.style.left = '345px'; // To Comparator input
            tD.style.top = '265px';
            await wait(800);

            // Logic Check
            if (dVal < limit) {
                // VALID
                setStatus("Valid (d < limit). Proceeding to relocation.", "green");
                tLim.remove(); // Consumed
                // tD continues to Adder
                
                // Animate D moving from Comparator to Adder
                tD.style.left = '565px'; // Adder X
                tD.style.top = '265px'; // Adder Y center
                
                // Animate Base into Adder
                tBase.style.top = '265px'; 
                tBase.style.left = '565px';
                
                await wait(1000);
                tBase.remove();
                tD.remove();

                // Calculate Result
                const phy = base + dVal;
                setStatus(`Step 4: Base + d = Physical Address ${phy}`);
                
                const tRes = createToken(phy, 'res', 565, 265);
                await wait(100);
                tRes.style.left = '660px'; // Move to memory
                
                // Calculate visual height in memory block (approx)
                // 400px height. Max addr ~8000.
                const memY = 40 + 20 + (phy / 8000 * 360);
                tRes.style.top = memY + 'px';
                
                await wait(1000);
                tRes.remove();

                // Highlight Memory
                const hl = document.getElementById('mem-hl');
                hl.style.top = (phy / 8000 * 380) + 'px'; // relative to mem body
                hl.style.height = '15px';
                hl.style.opacity = 1;
                hl.innerText = phy;
                
                setStatus("Success! Memory Accessed.", "green");

            } else {
                // TRAP
                setStatus(`Error: Offset ${dVal} >= Limit ${limit}. TRAP!`, "#c0392b");
                tLim.remove();
                tBase.remove();
                
                // Move D to Trap
                tD.style.top = '380px'; // Down to trap
                await wait(600);
                tD.remove();
                
                const trapBox = document.getElementById('trap-box');
                trapBox.style.display = 'block';
                trapBox.style.animation = 'pulse 0.5s';
            }

            btn.disabled = false;
        }

        init();
    </script>
</body>
</html>