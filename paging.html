<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Paging Simulation</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --highlight-color: #f1c40f;
            --error-color: #e74c3c;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { color: var(--dark-bg); margin-bottom: 10px; }
        p { max-width: 800px; text-align: center; margin-bottom: 20px; }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* Components */
        .box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .box h3 { margin-top: 0; border-bottom: 2px solid var(--light-bg); width: 100%; text-align: center; padding-bottom: 10px; }

        /* CPU & Address */
        .address-box {
            display: flex;
            border: 2px solid #333;
            margin-top: 10px;
            font-family: monospace;
            font-size: 1.2em;
        }
        .addr-part { padding: 5px 10px; text-align: center; }
        .p-part { background-color: #e8f6f3; border-right: 1px solid #333; }
        .d-part { background-color: #fef9e7; }
        .label { font-size: 0.7em; color: #666; display: block; }

        /* Memory Visuals */
        .memory-grid {
            display: grid;
            grid-template-columns: 1fr;
            width: 100%;
            gap: 2px;
            border: 1px solid #ddd;
            background: #eee;
            max-height: 400px;
            overflow-y: auto;
        }

        .memory-cell {
            background: white;
            padding: 5px;
            font-family: monospace;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }
        
        .memory-cell.header { background: #ddd; font-weight: bold; }
        
        .active-row { background-color: var(--highlight-color) !important; transition: background 0.5s; }
        .target-row { background-color: var(--secondary-color) !important; color: white; transition: background 0.5s; }
        .miss-row { background-color: var(--error-color) !important; color: white; transition: background 0.5s; }

        /* Tables (TLB & Page Table) */
        table { width: 100%; border-collapse: collapse; font-family: monospace; }
        th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        th { background-color: #f8f9fa; }

        /* Animation Lines (Canvas Overlay) */
        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Status Log */
        .status-panel {
            grid-column: 1 / -1;
            background: #333;
            color: #0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>

    <h1>Interactive Paging Simulation</h1>
    <p>This simulation demonstrates the hardware address translation using a <b>Page Table</b> and a <b>TLB (Translation Look-aside Buffer)</b>.</p>

    <div class="controls">
        <label>Simulation Speed: 
            <select id="speedSelect">
                <option value="1500">Slow</option>
                <option value="800" selected>Normal</option>
                <option value="300">Fast</option>
            </select>
        </label>
        <button id="btnGenerate" onclick="startSimulation()">Generate CPU Request</button>
        <button id="btnReset" onclick="resetSimulation()" style="background-color: #7f8c8d;">Reset</button>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="dot" style="background:var(--highlight-color)"></div> Scanning/Lookup</div>
        <div class="legend-item"><div class="dot" style="background:var(--secondary-color)"></div> Hit/Found</div>
        <div class="legend-item"><div class="dot" style="background:var(--error-color)"></div> Miss</div>
    </div>

    <div class="container" style="position: relative;">
        <canvas id="canvas-overlay"></canvas>

        <div class="box" id="cpuBox">
            <h3>CPU (Logical Address)</h3>
            <div style="margin: 10px 0;">Generating Logic Address...</div>
            <div class="address-box" id="cpuAddressDisplay" style="opacity: 0.3;">
                <div class="addr-part p-part">
                    <span class="label">Page (p)</span>
                    <span id="val-p">0</span>
                </div>
                <div class="addr-part d-part">
                    <span class="label">Offset (d)</span>
                    <span id="val-d">0</span>
                </div>
            </div>
            <p style="font-size: 0.8em; color: #555; margin-top: 5px;">Example: 16-entry Logical Memory</p>
        </div>

        <div class="box" id="tlbBox">
            <h3>TLB (Cache)</h3>
            <table>
                <thead>
                    <tr><th>Page (p)</th><th>Frame (f)</th></tr>
                </thead>
                <tbody id="tlbTableBody">
                    </tbody>
            </table>
            <div id="tlbStatus" style="margin-top:5px; font-weight: bold; height: 20px;"></div>
        </div>

        <div class="box" id="ptBox">
            <h3>Page Table</h3>
            <div class="memory-grid" id="pageTableGrid">
                <div class="memory-cell header"><span>Pg#</span><span>Frame#</span></div>
                </div>
        </div>

        <div class="box" id="ramBox">
            <h3>Physical Memory</h3>
            <div class="memory-grid" id="phyMemGrid">
                <div class="memory-cell header"><span>Addr</span><span>Content</span></div>
                </div>
            <div class="address-box" id="phyAddressDisplay" style="margin-top: 10px; opacity: 0; border-color: var(--secondary-color);">
                <div class="addr-part p-part" style="background:#e8f8f5;">
                    <span class="label">Frame (f)</span>
                    <span id="val-f">-</span>
                </div>
                <div class="addr-part d-part">
                    <span class="label">Offset (d)</span>
                    <span id="val-d-phy">-</span>
                </div>
            </div>
        </div>

        <div class="status-panel" id="logPanel">
            > System Ready. Click "Generate CPU Request" to start.
        </div>
    </div>

    <script>
        // --- Configuration ---
        const PAGE_COUNT = 8;
        const FRAME_COUNT = 16;
        const TLB_SIZE = 3;
        const PAGE_SIZE = 4; // Visual representation size

        // --- State ---
        let pageTable = [];
        let tlb = [];
        let isAnimating = false;

        // --- DOM Elements ---
        const logPanel = document.getElementById('logPanel');
        const canvas = document.getElementById('canvas-overlay');
        const ctx = canvas.getContext('2d');

        // --- Initialization ---
        function init() {
            // Initialize Page Table (Random Frame assignments, some invalid represented by -1)
            pageTable = [];
            const usedFrames = new Set();
            for (let i = 0; i < PAGE_COUNT; i++) {
                let frame = -1;
                // 80% chance of being valid
                if (Math.random() > 0.2) {
                    do {
                        frame = Math.floor(Math.random() * FRAME_COUNT);
                    } while (usedFrames.has(frame));
                    usedFrames.add(frame);
                }
                pageTable.push(frame);
            }

            // Initialize TLB (Empty initially)
            tlb = [];

            renderPageTable();
            renderTLB();
            renderPhysicalMemory();
            resizeCanvas();
        }

        // --- Rendering Functions ---
        function renderPageTable() {
            const container = document.getElementById('pageTableGrid');
            container.innerHTML = '<div class="memory-cell header"><span>Pg (p)</span><span>Frame (f)</span></div>';
            pageTable.forEach((frame, idx) => {
                const row = document.createElement('div');
                row.className = 'memory-cell';
                row.id = `pt-row-${idx}`;
                row.innerHTML = `<span>${idx}</span><span>${frame === -1 ? 'Invalid' : frame}</span>`;
                container.appendChild(row);
            });
        }

        function renderTLB() {
            const tbody = document.getElementById('tlbTableBody');
            tbody.innerHTML = '';
            // Fill empty slots if TLB is not full
            const displayRows = [...tlb];
            while (displayRows.length < TLB_SIZE) displayRows.push(null);

            displayRows.forEach((entry, idx) => {
                const tr = document.createElement('tr');
                tr.id = `tlb-row-${idx}`;
                if (entry) {
                    tr.innerHTML = `<td>${entry.p}</td><td>${entry.f}</td>`;
                } else {
                    tr.innerHTML = `<td>-</td><td>-</td>`;
                }
                tbody.appendChild(tr);
            });
        }

        function renderPhysicalMemory() {
            const container = document.getElementById('phyMemGrid');
            container.innerHTML = '<div class="memory-cell header"><span>Frame#</span><span>Data</span></div>';
            for(let i=0; i<FRAME_COUNT; i++) {
                const row = document.createElement('div');
                row.className = 'memory-cell';
                row.id = `mem-row-${i}`;
                row.innerHTML = `<span>Frame ${i}</span><span>[Data ${i}]</span>`;
                container.appendChild(row);
            }
        }

        function log(msg) {
            logPanel.innerHTML += `\n> ${msg}`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function clearHighlights() {
            document.querySelectorAll('.active-row, .target-row, .miss-row').forEach(el => {
                el.classList.remove('active-row', 'target-row', 'miss-row');
            });
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('tlbStatus').innerText = '';
            document.getElementById('phyAddressDisplay').style.opacity = '0';
        }

        // --- Animation Helper ---
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        
        function getSpeed() {
            return parseInt(document.getElementById('speedSelect').value);
        }

        // --- Core Simulation Logic ---
        async function startSimulation() {
            if (isAnimating) return;
            isAnimating = true;
            document.getElementById('btnGenerate').disabled = true;
            clearHighlights();
            
            // 1. Generate Address
            const logicalPage = Math.floor(Math.random() * PAGE_COUNT);
            const offset = Math.floor(Math.random() * 99); // Arbitrary offset
            
            document.getElementById('val-p').innerText = logicalPage;
            document.getElementById('val-d').innerText = offset;
            document.getElementById('cpuAddressDisplay').style.opacity = '1';
            
            log(`CPU generated Logical Address: Page ${logicalPage}, Offset ${offset}`);
            await sleep(getSpeed());

            // 2. Check TLB
            log("Checking TLB (Translation Look-aside Buffer)...");
            let tlbHitIndex = -1;
            let frameNumber = -1;

            // Animate TLB scan
            const tlbRows = document.getElementById('tlbTableBody').children;
            for (let i = 0; i < tlb.length; i++) {
                if (tlbRows[i]) tlbRows[i].classList.add('active-row');
                await sleep(getSpeed() / 2);
                
                if (tlb[i].p === logicalPage) {
                    tlbHitIndex = i;
                    frameNumber = tlb[i].f;
                    if (tlbRows[i]) {
                        tlbRows[i].classList.remove('active-row');
                        tlbRows[i].classList.add('target-row');
                    }
                    break;
                }
                if (tlbRows[i]) tlbRows[i].classList.remove('active-row');
            }

            if (tlbHitIndex !== -1) {
                // TLB HIT
                document.getElementById('tlbStatus').innerHTML = '<span style="color:var(--secondary-color)">TLB HIT!</span>';
                log(`TLB Hit! Page ${logicalPage} maps to Frame ${frameNumber}.`);
                drawArrow('tlbBox', 'ramBox');
            } else {
                // TLB MISS
                document.getElementById('tlbStatus').innerHTML = '<span style="color:var(--error-color)">TLB MISS</span>';
                log(`TLB Miss. Consult Page Table in memory.`);
                drawArrow('tlbBox', 'ptBox');
                await sleep(getSpeed());

                // 3. Access Page Table
                log(`Accessing Page Table for Page ${logicalPage}...`);
                const ptRow = document.getElementById(`pt-row-${logicalPage}`);
                if (ptRow) {
                    ptRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    ptRow.classList.add('active-row');
                }
                await sleep(getSpeed());

                frameNumber = pageTable[logicalPage];

                if (frameNumber === -1) {
                    // Page Fault / Invalid
                    if (ptRow) {
                        ptRow.classList.remove('active-row');
                        ptRow.classList.add('miss-row');
                    }
                    log(`ERROR: Invalid Page Reference (Trap to OS).`);
                    isAnimating = false;
                    document.getElementById('btnGenerate').disabled = false;
                    return;
                }

                if (ptRow) {
                    ptRow.classList.remove('active-row');
                    ptRow.classList.add('target-row');
                }
                log(`Page Table: Page ${logicalPage} is in Frame ${frameNumber}.`);

                // Update TLB
                log(`Updating TLB with new mapping (Page ${logicalPage} -> Frame ${frameNumber}).`);
                updateTLB(logicalPage, frameNumber);
                drawArrow('ptBox', 'ramBox');
            }

            await sleep(getSpeed());

            // 4. Access Physical Memory
            log(`Constructing Physical Address: Frame ${frameNumber}, Offset ${offset}.`);
            
            document.getElementById('val-f').innerText = frameNumber;
            document.getElementById('val-d-phy').innerText = offset;
            document.getElementById('phyAddressDisplay').style.opacity = '1';

            const memRow = document.getElementById(`mem-row-${frameNumber}`);
            if (memRow) {
                memRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                memRow.classList.add('target-row');
            }
            log(`DATA ACCESSED successfully at Physical Address.`);

            isAnimating = false;
            document.getElementById('btnGenerate').disabled = false;
        }

        function updateTLB(p, f) {
            // FIFO Replacement if full
            if (tlb.length >= TLB_SIZE) {
                tlb.shift(); // Remove oldest
            }
            tlb.push({ p, f });
            renderTLB();
            // Highlight the new entry
            const rows = document.getElementById('tlbTableBody').children;
            const newRow = rows[rows.length - 1];
            if (newRow) newRow.classList.add('target-row');
        }

        function resetSimulation() {
            logPanel.innerHTML = '> System Reset.';
            init();
            clearHighlights();
            document.getElementById('cpuAddressDisplay').style.opacity = '0.3';
        }

        // --- Canvas Drawing (Simple Arrows) ---
        function resizeCanvas() {
            canvas.width = document.querySelector('.container').offsetWidth;
            canvas.height = document.querySelector('.container').offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function drawArrow(fromId, toId) {
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);
            const container = document.querySelector('.container');
            
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            const contRect = container.getBoundingClientRect();

            const startX = (fromRect.left + fromRect.width / 2) - contRect.left;
            const startY = (fromRect.top + fromRect.height / 2) - contRect.top;
            const endX = (toRect.left + toRect.width / 2) - contRect.left;
            const endY = (toRect.top + toRect.height / 2) - contRect.top;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Arrowhead
            const angle = Math.atan2(endY - startY, endX - startX);
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - 10 * Math.cos(angle - Math.PI / 6), endY - 10 * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(endX - 10 * Math.cos(angle + Math.PI / 6), endY - 10 * Math.sin(angle + Math.PI / 6));
            ctx.fillStyle = '#e74c3c';
            ctx.fill();
        }

        // Start
        init();

    </script>
</body>
</html>